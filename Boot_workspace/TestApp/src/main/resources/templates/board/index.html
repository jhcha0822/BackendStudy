<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<title>Insert title here</title>
</head>
<body style="background:aliceblue">
	
	<div class="container">
		<div class="row mt-3">
			<!-- row안의 요소들은 수평으로 배치 가능 -->
			<div class="col-md-3">
				<form id="form1">
					<div class="form-group">
						<input type="text" class="form-control" placeholder="Enter title" name="title">
					</div>
					<div class="form-group">
				    	<input type="text" class="form-control" placeholder="Enter writer" name="writer">
			    	</div>
			    	<div class="form-group">
				    	<textarea class="form-control" placeholder="Enter content" name="content"></textarea>
			    	</div>
			    	<button type="button" class="btn btn-primary" id="bt_regist">submit</button>
			    </form>
			</div>
			<div class="col-md-6">
				<!-- 검색 -->
				<div class="row">
					<div class="col-md-12">
						<form id="form2">
							<select>
								<option>검색 기준▼</option>
								<option value="title">제목</option>
								<!-- <option>작성자</option>
								<option>내용</option> -->							
							</select>
							<input type="text" name="title" placeholder="Title to Search">
							<button type="button" class="btn btn-primary" id="bt_search">검색</button>
						</form>
					</div>
				</div>
				<!-- 목록 -->
				<div class="row" id="listBox">
				
				</div>
			</div>
			<div class="col-md-3">
				<form id="form3">
					<input type="hidden" name="board_idx">
					<div class="form-group">
						<input type="text" class="form-control" name="title">
					</div>
					<div class="form-group">
				    	<input type="text" class="form-control" name="writer">
			    	</div>
			    	<div class="form-group">
				    	<textarea class="form-control" name="content"></textarea>
			    	</div>
				    <button type="button" class="btn btn-primary" id="bt_edit">edit</button>
				    <button type="button" class="btn btn-primary" id="bt_del">delete</button>			    	
			    </form>
			</div>
		</div>
	</div>
	
</body>
</html>
<script>

class Board{
	constructor(data){
		this.tag = "<table width='100%' border='1px'";
		this.tag += "<tr>";
		this.tag += "<th>글번호</th>";
		this.tag += "<th>글제목</th>";
		this.tag += "<th>글쓴이</th>";
		this.tag += "<th>등록일</th>";
		this.tag += "<th>조회수</th>";
		this.tag += "</tr>";
		
		for(let i=0; i<data.length; i++) {
			let board = data[i];
			this.tag += "<tr>";
			this.tag += "<td>"+board.board_idx+"</td>";
			this.tag += "<td><a href=\"javascript:getDetail("+board.board_idx+")\">"+board.title+"</a></td>";
			// 비동기요청으로 가져와야 함
			// this.tag += "<td><a href='/board/"+board.board_idx+"'>"+board.title+"</a></td>";
			this.tag += "<td>"+board.writer+"</td>";
			this.tag += "<td>"+board.regdate+"</td>";
			this.tag += "<td>"+board.hit+"</td>";
			this.tag += "</tr>";
		}
		this.tag += "</table>";
	}
}


	function render(data) {
		let board = new Board(data);
		$("#listBox").html(board.tag);
	}

	function getList() {
		$.ajax({
			url:"/board",
			type:"GET", // type가 "POST"면 아래 regist와 충돌
			success:function(result, status, xhr){
				// console.log(result);
				render(result);
			}
		});
	}
	
	// 비동기 상세보기 요청: JSON값을 받아오고 현재 창에 입력
	function getDetail(board_idx) {
		$.ajax({
			url:"/board/"+board_idx,
			type:"get",
			success:function(result, status, xhr){
				$("#form3 input[name='board_idx']").val(result.board_idx);
				$("#form3 input[name='title']").val(result.title);
				$("#form3 input[name='writer']").val(result.writer);
				$("#form3 textarea[name='content']").html(result.content);
			}
		});
	}

	function regist(){
		$.ajax({
			url:"/board",
			type:"POST",
			// jQuery Ajax에서 data 속성 작성 시 파라미터를 일일이 명시하는 것은 유지보수성이 낮음
			// 기존의 form 태그를 date에 대입하는 방법 이용: form 태그 내의 컴포넌트 파라미터명과 값을 문자열화해주는 메서드
			data:$("#form1").serialize(), // title=~~~&writer=~~~&content=~~~
			/*	
				{
				// title : $("#form1 input[name='title']").val(),
				// writer : $("#form1 input[name='writer']").val(),
				// content : $("#form1 textarea[name='content']").val()
			} 
			*/
			success:function(result, status, xhr){
				// alert("게시물 등록 성공");
				// 서버에 목록 요청
				getList();
			},
			error:function(xhr, status, err){
				alert("게시물 등록 실패");
			}
		});
	}
	
	// 비동기 수정 요청
	function edit(){
		$.ajax({
			url:"/board",
			type:"PUT",
			data:$("#form3").serialize(), // 데이터가 일렬로 모아져서 전송
			success:function(result, status, xhr){
				getList(); // 수정에 성공하였으니 리스트 갱신
			}
		});
	}
	
	// 비동기 삭제 요청
	function del(){
		$.ajax({
			url:"/board/"+$("#form3 input[name='board_idx']").val(),
			type:"DELETE",
			success:function(result, status, xhr){
				getList();
				
				// 우측 영역 초기화
				$("#form3 input[name='board_idx']").val("");
				$("#form3 input[name='title']").val("");
				$("#form3 input[name='writer']").val("");
				$("#form3 textarea[name='content']").html("");
			},
			error:function(xhr, status, err){
				alert("삭제 실패");
			}
		});
	}
	
	// 비동기 검색 요청
	function findList(){
		$.ajax({
			url:"/search/board?title="+$("#form2 input[name='title']").val(),
			type:"get",
			success:function(result, status, xhr){
				console.log(result);
				render(result);
			}
		});
	}

	$(function(){
		getList();
		$("#bt_regist").click(function(){
			// 유효성 체크
			if($("#form1 input[name='title']").val().length < 1)
				alert("제목을 입력하시오");
			else if($("#form1 input[name='writer']").val().length < 1)
				alert("작성자를 입력하시오");
			else if($("#form1 textarea[name='content']").val().length < 1)
				alert("내용을 입력하시오");
			else
				regist();
		});
		$("#bt_edit").click(function(){
			if(confirm("수정하시겠습니까?"))
				edit();
		});
		$("#bt_del").click(function(){
			if(confirm("삭제하시겠습니까?")){
				// 유효성 체크
				if($("#form3 input[name='title']").val().length < 1)
					alert("좌측에서 게시물을 선택하시오");
				else if($("#form3 input[name='writer']").val().length < 1)
					alert("좌측에서 게시물을 선택하시오");
				else if($("#form3 textarea[name='content']").val().length < 1)
					alert("좌측에서 게시물을 선택하시오");
				else				
					del();
			}
		});
		
		$("#bt_search").click(function(){
			findList();
		})
	});

</script>